name: Fetch Data

on:
  push:
    branches:
      - main  # Trigger the workflow on any push to the main branch
  workflow_dispatch:  # Allow manual triggering of the workflow

jobs:
  fetch-data:
    runs-on: ubuntu-latest  # Or your desired runner OS
    steps:
      - name: Checkout code
        uses: actions/checkout@v3  # Checks out your code

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install jq 

      - name: Fetch data from Google Sheet
        run: |
          curl --request GET \
          --url 'https://sheets.googleapis.com/v4/spreadsheets/19r8IWr7xwpP2NhtQzs_5m00FaKbGcOfN95uiyr55zH4/values/A:A' \
          --header 'Authorization: Bearer ya29.a0Ad52N3-phzPKiUlDp82zPRhYghxWZnRqPn6MJIeHGMpOEOjvt1hYEWPn3OQxphpmzh0Kh_QFln81EE40ZfUXvgFnG3Ce5212QODmSmP9Oe9FsNt6lzKVHk6GrFKeA8toeGBwtho9O2ePRUMzWrCXTG6Q0Ucdka5CkElKaCgYKARASARESFQHGX2MivhnK3jNFweTyBHqRS4TgkA0171' \
          --header 'Accept: application/json' \
          --output data.json

      - name: Print fetched data
        run: |
          cat data.json

      - name: Extract values array
        run: |
          jq -r '.values[] | .[]' data.json | tr '\n' ',' > values.txt

      - name: Update app-ads.txt
        run: |
          cat values.txt > app-ads.txt 

      - name: Create virtual environment
        run: |
          python3 -m venv venv

      - name: Activate virtual environment
        run: |
          source venv/bin/activate

      - name: Install Python dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 python3-pip
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt

      - name: Run reformat.py
        run: |
          python3 reformat.py
      
      - name: Print app-ads.txt
        run: |
          cat app-ads.txt